# ğŸ¤– Qwen Code OAuth Plugin for OpenCode (Improved)

> **æ”¹è¿›ç‰ˆ** - åœ¨ [opencode-qwencode-auth](https://github.com/gustavodiasdev/opencode-qwencode-auth) åŸºç¡€ä¸Šæ·»åŠ äº†è¯·æ±‚èŠ‚æµã€429 å¤„ç†ã€è¯·æ±‚å¤´å¯¹é½ç­‰å¢å¼ºåŠŸèƒ½

![License](https://img.shields.io/github/license/gustavodiasdev/opencode-qwencode-auth)

---

## âœ¨ åœ¨æ‚¨çš„ OpenCode ä¸Šä½¿ç”¨ Qwen æœ€æ–°æœ€å¼ºçš„æ¨¡å‹ Qwen3.5 Plus!
![alt text](726a626d29d2c09e13e97c1a974e89eb.jpg)
![alt text](4f5d83ebb1d715f68fa839bf856dd7b3.jpg)

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…æ’ä»¶

```bash
cd ~/.opencode && npm install opencode-qwencode-auth
```

### 2. å¯ç”¨æ’ä»¶

ç¼–è¾‘ `~/.opencode/opencode.jsonc`ï¼š

```json
{
  "plugin": ["opencode-qwencode-auth"]
}
```

### 3. ç™»å½•è®¤è¯

```bash
opencode auth login
```

ç„¶åç–¯ç‹‚æŒ‰"â†“",é€‰æ‹© **"Other"** â†’ è¾“å…¥ `qwen-code` â†’ é€‰æ‹© **"Qwen Code (qwen.ai OAuth)"**

æµè§ˆå™¨ä¼šè‡ªåŠ¨æ‰“å¼€ï¼Œç™»å½• qwen.ai å¹¶æˆæƒå³å¯ã€‚

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### åŸºç¡€åŠŸèƒ½
- ğŸ” **OAuth Device Flow** - åŸºäº RFC 8628 çš„æ ‡å‡†è®¤è¯æµç¨‹
- ğŸ†“ **1000 æ¬¡/å¤©å…è´¹** - æ— éœ€ API Keyï¼Œæ— éœ€ä¿¡ç”¨å¡
- ğŸ”„ **è‡ªåŠ¨ Token åˆ·æ–°** - è¿‡æœŸå‰è‡ªåŠ¨ç»­æœŸ
- ğŸ”— **å‡­è¯å…±äº«** - ä¸ Qwen Code CLI å…±äº« `~/.qwen/oauth_creds.json`

### æ”¹è¿›åŠŸèƒ½ï¼ˆæœ¬ç‰ˆæœ¬ç‹¬æœ‰ï¼‰
- â±ï¸ **è¯·æ±‚èŠ‚æµ** - æ§åˆ¶ 1 ç§’/æ¬¡ï¼Œé¿å…è§¦å‘ 60 æ¬¡/åˆ†é’Ÿé™åˆ¶
- ğŸ“¡ **429 è‡ªåŠ¨é‡è¯•** - é‡åˆ°é™æµè‡ªåŠ¨ç­‰å¾…åé‡è¯•
- ğŸ² **è¯·æ±‚æŠ–åŠ¨** - 0.5-1.5s éšæœºå»¶è¿Ÿï¼Œé¿å…å›ºå®šæ¨¡å¼
- ğŸ·ï¸ **è¯·æ±‚å¤´å¯¹é½** - ä¸ qwen-code CLI å®Œå…¨ä¸€è‡´çš„ Headers

---

## ğŸ¯ å¯ç”¨æ¨¡å‹

> **é‡è¦**ï¼šQwen OAuth ä»…æ”¯æŒ 2 ä¸ªæ¨¡å‹ï¼Œä¸ qwen-code CLI å®Œå…¨å¯¹é½ã€‚

| æ¨¡å‹ | ä¸Šä¸‹æ–‡ | æœ€å¤§è¾“å‡º | è¯´æ˜ |
|------|--------|---------|------|
| `coder-model` | 1M tokens | 64K tokens | ä»£ç æ¨¡å‹ï¼ˆé»˜è®¤ï¼Œæ¨èï¼‰ |
| `vision-model` | 128K tokens | 32K tokens | è§†è§‰æ¨¡å‹ |

### ä½¿ç”¨ç¤ºä¾‹

```bash
# ä½¿ç”¨ä»£ç æ¨¡å‹ï¼ˆæ¨èï¼‰
opencode --provider qwen-code --model coder-model

# ä½¿ç”¨è§†è§‰æ¨¡å‹
opencode --provider qwen-code --model vision-model
```

> **æ³¨æ„**ï¼š![alt text](image.png)
æ ¹æ®qwen codeæè¿°,coder-model æ¨¡å‹å°±æ˜¯æœ€æ–°å‘å¸ƒçš„qwen 3.5 plus


---

## ğŸ“Š ä½¿ç”¨é™åˆ¶

| è®¡åˆ’ | é€Ÿç‡é™åˆ¶ | æ¯æ—¥é™åˆ¶ |
|------|---------|---------|
| Free (OAuth) | 60 æ¬¡/åˆ†é’Ÿ | 1000 æ¬¡/å¤© |

> é™åˆ¶äºåŒ—äº¬æ—¶é—´æ¬¡æ—¥ 0 ç‚¹é‡ç½®ã€‚å¦‚éœ€æ›´é«˜é™åˆ¶ï¼Œå¯ä½¿ç”¨ [DashScope API](https://dashscope.aliyun.com)ã€‚

---

## âš™ï¸ æ’ä»¶å·¥ä½œåŸç†

### æ•´ä½“æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·è¾“å…¥é—®é¢˜                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      OpenCode CLI                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ åŠ è½½æ’ä»¶                                                    â”‚ â”‚
â”‚  â”‚   â”œâ”€ loader: è¿”å› apiKey + fetch å‡½æ•°                       â”‚ â”‚
â”‚  â”‚   â””â”€ methods: å¤„ç† OAuth è®¤è¯                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ’ä»¶ fetch æ‹¦æˆªå™¨                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. æ·»åŠ  Headers                                           â”‚  â”‚
â”‚  â”‚    - User-Agent: QwenCode/0.10.3 (linux; x64)            â”‚  â”‚
â”‚  â”‚    - X-DashScope-CacheControl: enable                    â”‚  â”‚
â”‚  â”‚    - X-DashScope-AuthType: qwen-oauth                    â”‚  â”‚
â”‚  â”‚ 2. æ·»åŠ  Authorization: Bearer <token>                     â”‚  â”‚
â”‚  â”‚ 3. è¯·æ±‚èŠ‚æµ (1 ç§’é—´éš” + éšæœºæŠ–åŠ¨)                           â”‚  â”‚
â”‚  â”‚ 4. 429 å¤„ç† (ç­‰å¾…åé‡è¯•)                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    portal.qwen.ai/v1                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ’ä»¶çš„ä¸‰ä¸ªè§’è‰²

| è§’è‰² | å‡½æ•° | ä½œç”¨ |
|------|------|------|
| **è®¤è¯æä¾›è€…** | `loader` | è¿”å›é…ç½®ï¼ˆapiKey + baseURL + fetchï¼‰ |
| **è¯·æ±‚æ‹¦æˆªå™¨** | `fetch` | æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼Œæ·»åŠ  Headers + èŠ‚æµ |
| **OAuth å…¥å£** | `methods` | å¤„ç†ç”¨æˆ·ç™»å½•ï¼Œè·å– access token |

---

## ğŸ”¬ è®¾è®¡ç»†èŠ‚

### 1. è¯·æ±‚èŠ‚æµï¼ˆThrottlingï¼‰

**é—®é¢˜**ï¼šOpenCode äº§ç”Ÿè¯·æ±‚æ¯” Qwen Code CLI å¤šï¼Œå®¹æ˜“è§¦å‘ 60 æ¬¡/åˆ†é’Ÿé™åˆ¶ã€‚

**è§£å†³**ï¼šè¯·æ±‚é˜Ÿåˆ—æ§åˆ¶é€Ÿç‡ã€‚

```typescript
class RequestQueue {
  private lastRequestTime = 0;
  private readonly MIN_INTERVAL = 1000; // 1 ç§’

  async enqueue<T>(fn: () => Promise<T>): Promise<T> {
    const elapsed = Date.now() - this.lastRequestTime;
    const waitTime = Math.max(0, this.MIN_INTERVAL - elapsed);
    
    if (waitTime > 0) {
      await new Promise(resolve => setTimeout(resolve, waitTime));
    }
    
    this.lastRequestTime = Date.now();
    return fn();
  }
}
```

**æ•ˆæœ**ï¼šç¡®ä¿æ¯æ¬¡è¯·æ±‚é—´éš” â‰¥ 1 ç§’ï¼Œä¸ä¼šè¶…è¿‡ 60 æ¬¡/åˆ†é’Ÿã€‚

---

### 2. è¯·æ±‚æŠ–åŠ¨ï¼ˆJitterï¼‰

**é—®é¢˜**ï¼šå›ºå®šé—´éš”çš„è¯·æ±‚æ¨¡å¼å¯èƒ½è¢«è¯†åˆ«ä¸º"éæ­£å¸¸ç”¨æˆ·"ã€‚

**è§£å†³**ï¼šåœ¨ 1 ç§’åŸºç¡€ä¸Šæ·»åŠ  0.5-1.5s éšæœºå»¶è¿Ÿã€‚

```typescript
// src/plugin/request-queue.ts
private readonly JITTER_MIN = 500;
private readonly JITTER_MAX = 1500;

private getJitter(): number {
  return Math.random() * (this.JITTER_MAX - this.JITTER_MIN) + this.JITTER_MIN;
}
```

**æ•ˆæœ**ï¼šè¯·æ±‚é—´éš” = 1 ç§’ + (0.5~1.5s éšæœº) = 1.5-2.5s éšæœºï¼Œæ›´åƒçœŸå®ç”¨æˆ·è¡Œä¸ºã€‚

---

### 3. è¯·æ±‚å¤´å¯¹é½ï¼ˆHeader Alignmentï¼‰

**é—®é¢˜**ï¼šæœåŠ¡å™¨å¯èƒ½é€šè¿‡ Headers è¯†åˆ«å®¢æˆ·ç«¯æ¥æºã€‚

**è§£å†³**ï¼šæ¨¡æ‹Ÿ qwen-code CLI çš„ Headersã€‚

```typescript
headers.set('User-Agent', `QwenCode/0.10.3 (${platform}; ${arch})`);
headers.set('X-DashScope-CacheControl', 'enable');
headers.set('X-DashScope-UserAgent', `QwenCode/0.10.3 (${platform}; ${arch})`);
headers.set('X-DashScope-AuthType', 'qwen-oauth');
```

**æ•ˆæœ**ï¼šä» Headers çœ‹ï¼Œè¯·æ±‚ä¸ qwen-code CLI æ— æ³•åŒºåˆ†ã€‚

---

### 4. 429 é”™è¯¯å¤„ç†

**é—®é¢˜**ï¼šå³ä½¿èŠ‚æµï¼Œä»å¯èƒ½å¶å°”è§¦å‘é™æµã€‚

**è§£å†³**ï¼šè‡ªåŠ¨ç­‰å¾…åé‡è¯•ã€‚

```typescript
if (response.status === 429) {
  const retryAfter = response.headers.get('Retry-After') || '60';
  await sleep(parseInt(retryAfter) * 1000);
  return fetch(input, { headers }); // é‡è¯•
}
```

**æ•ˆæœ**ï¼šé‡åˆ°é™æµè‡ªåŠ¨æ¢å¤ï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„ã€‚

---

## âœ¨ æ”¹è¿›åŠŸèƒ½

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| â±ï¸ è¯·æ±‚èŠ‚æµ | 1 ç§’é—´éš” + 0.5-1.5s éšæœºæŠ–åŠ¨ï¼Œé¿å…è§¦å‘ 60 æ¬¡/åˆ†é’Ÿé™åˆ¶ |
| ğŸ“¡ 429 è‡ªåŠ¨é‡è¯• | é‡åˆ°é™æµè‡ªåŠ¨ç­‰å¾…åé‡è¯• |
| ğŸ·ï¸ è¯·æ±‚å¤´å¯¹é½ | User-Agentã€X-DashScope-* ä¸ qwen-code CLI å®Œå…¨ä¸€è‡´ |
| ğŸ’¾ Token ç¼“å­˜ | 5 åˆ†é’Ÿå†…ä¸é‡å¤åˆ·æ–°ï¼Œå‡å°‘é¢å¤–è¯·æ±‚ |
| ğŸ¯ æ¨¡å‹ç²¾ç®€ | ä»…æ”¯æŒ 2 ä¸ªæ¨¡å‹ï¼ˆcoder-modelã€vision-modelï¼‰ï¼Œä¸ qwen-code CLI å¯¹é½ |

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### Token è¿‡æœŸ

æ’ä»¶ä¼šè‡ªåŠ¨åˆ·æ–° Tokenã€‚å¦‚ä»æœ‰é—®é¢˜ï¼š

```bash
# åˆ é™¤æ—§å‡­è¯
rm ~/.qwen/oauth_creds.json

# é‡æ–°è®¤è¯
opencode auth login
```

### 429 é”™è¯¯é¢‘ç¹

- æ£€æŸ¥æ˜¯å¦åŒæ—¶è¿è¡Œå¤šä¸ª OpenCode å®ä¾‹
- ç­‰å¾…é…é¢é‡ç½®ï¼ˆåŒ—äº¬æ—¶é—´ 0 ç‚¹ï¼‰

### æ’ä»¶ä¸æ˜¾ç¤º

åœ¨ `opencode auth login` ä¸­ï¼š
1. é€‰æ‹© **"Other"**
2. è¾“å…¥ `qwen-code`

---

## ğŸ› ï¸ æœ¬åœ°å¼€å‘

### 1. å…‹éš†é¡¹ç›®

```bash
git clone https://github.com/RunMintOn/OpenCode-Qwen-Auth.git
cd OpenCode-Qwen-Auth
```

### 2. å®‰è£…ä¾èµ–

```bash
npm install
```

### 3. æœ¬åœ°æµ‹è¯•

ç¼–è¾‘ `~/.opencode/package.json`ï¼š

```json
{
  "dependencies": {
    "opencode-qwencode-auth": "...WHERE"
  }
}
```

ç„¶åï¼š

```bash
cd ~/.opencode && npm install
```

### 4. æ„å»º

```bash
npm run build
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
qwencode-auth-improved/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts              # æ’ä»¶å…¥å£ï¼ˆloader + fetch + methodsï¼‰
â”‚   â”œâ”€â”€ constants.ts          # OAuth ç«¯ç‚¹ã€æ¨¡å‹é…ç½®
â”‚   â”œâ”€â”€ types.ts              # TypeScript ç±»å‹
â”‚   â”œâ”€â”€ qwen/
â”‚   â”‚   â””â”€â”€ oauth.ts          # OAuth Device Flow + PKCE
â”‚   â””â”€â”€ plugin/
â”‚       â”œâ”€â”€ request-queue.ts  # è¯·æ±‚é˜Ÿåˆ— + èŠ‚æµ
â”‚       â””â”€â”€ auth.ts           # å‡­è¯ç®¡ç†
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

---

## ğŸ”— ç›¸å…³é¡¹ç›®

- **[opencode-qwencode-auth](https://github.com/gustavodiasdev/opencode-qwencode-auth)** - æœ¬é¡¹ç›®åŸºäºæ­¤æ’ä»¶æ”¹è¿›
- [qwen-code](https://github.com/QwenLM/qwen-code) - å®˜æ–¹ Qwen Code CLI
- [OpenCode](https://opencode.ai) - AI ç¼–ç¨‹åŠ©æ‰‹ CLI
- [opencode-antigravity-auth](https://github.com/NoeFabris/opencode-antigravity-auth) - Google OAuth å‚è€ƒå®ç°


---

## ğŸ“„ è®¸å¯è¯

MIT

---

<p align="center">
  åŸºäº <a href="https://github.com/gustavodiasdev/opencode-qwencode-auth">opencode-qwencode-auth</a> æ”¹è¿›
</p>
